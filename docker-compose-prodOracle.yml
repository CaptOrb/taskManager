services:
  mysqldb:
    image: mysql:8.4
    restart: unless-stopped
    env_file: ./.env
    environment:
      - MYSQL_USER=$DB_USERNAME
      - MYSQL_PASSWORD=$DB_PASSWORD
      - MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE=$MYSQLDB_DATABASE
    volumes:
      - db:/var/lib/mysql
    networks: [my_network]
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "mysqldb"]
      interval: 10s
      retries: 5
      timeout: 5s

  backend:
    image: conorb1/task-backend:latest
    pull_policy: always
    depends_on:
      mysqldb:
        condition: service_healthy
    restart: on-failure:5
    env_file: .env
    environment:
      JWT_SECRET: ${JWT_SECRET}
      NTFY_SERVER_URL: ${NTFY_SERVER_URL:?Set NTFY_SERVER_URL to your external ntfy URL}
      NTFY_PUBLIC_URL: ${NTFY_PUBLIC_URL:-}
      NTFY_ACCESS_TOKEN: ${NTFY_ACCESS_TOKEN:-}
      SPRING_APPLICATION_JSON: >
        {
          "spring.datasource.url": "jdbc:mysql://mysqldb:${MYSQLDB_DOCKER_PORT}/${MYSQLDB_DATABASE}?allowPublicKeyRetrieval=true&defaultAuthenticationPlugin=caching_sha2_password",
          "spring.datasource.username": "${DB_USERNAME}",
          "spring.datasource.password": "${DB_PASSWORD}",
          "spring.jpa.hibernate.ddl-auto": "none",
          "spring.flyway.enabled": "true",
          "spring.flyway.locations": "classpath:db/migration",
          "spring.flyway.baseline-on-migrate": "true",
          "spring.flyway.baseline-version": "1",
          "spring.jpa.open-in-view":"false"
        }
    networks: [my_network]

  frontend:
    image: conorb1/task-frontend:latest   # this should be Caddy (prod target)
    pull_policy: always
    container_name: task-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    networks: [my_network]
    depends_on: [backend]

volumes:
  db:
  caddy_data:
  caddy_config:

networks:
  my_network:
    driver: bridge
